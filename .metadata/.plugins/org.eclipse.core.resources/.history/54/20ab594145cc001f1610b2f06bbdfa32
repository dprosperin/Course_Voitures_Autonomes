/*
 * mymain.c
 *
 *  Created on: Jan 6, 2025
 *      Author: yassine.mesbahi
 */
#include "fdcan.h"
#include "stm32g4xx_hal.h"

FDCAN_TxHeaderTypeDef header;
uint8_t data[3];

uint8_t vitesse_m_s = 0 ;
uint8_t bit_fort ;
uint8_t bit_faible ;
uint16_t set_angle()
{
	 float data_lidar_main[360];

	 data_lidar_main [345] = 1405.0; // Assign float value
	 data_lidar_main[45] = 1149.0;  // Assign another float value

	 float difference  = data_lidar_main[345]-data_lidar_main [45] ;
	 float kp = 0.60 ;
	 float angle = 0.0 ;

	 uint16_t hexa_angle ;

	 angle = kp * difference ;

	 hexa_angle = 0x200+(angle/0.35) ;


	 return hexa_angle ;
}

void setup()
{

	/******************* NE PAS TOUCHER **************************************/
	header.ErrorStateIndicator = FDCAN_ESI_ACTIVE;
	header.BitRateSwitch = FDCAN_BRS_OFF;
	header.FDFormat = FDCAN_CLASSIC_CAN;
	header.TxEventFifoControl = FDCAN_NO_TX_EVENTS;
	header.MessageMarker = 0;
	/*************************************************************************/

	header.Identifier = 0x700; // Set your CAN identifier
	header.IdType = FDCAN_STANDARD_ID; // Standard ID
	header.TxFrameType = FDCAN_DATA_FRAME; // Data frame
	header.DataLength = 3; // Data length

}

void loop()
{
	//if ( 0xFFFFFFFFFFFFFF9C < set_angle() && set_angle() < 0x64 )
	//{
		vitesse_m_s = 11;
	//}
	//else
//	{
		//vitesse_m_s=5;
	//}

	bit_faible = set_angle() & 0xFF ;
	bit_fort = (set_angle()>>8)&0xFF;






	data [1] = bit_faible ;
	data [0] = 	bit_fort ;
	data [2] = vitesse_m_s ;


	HAL_FDCAN_AddMessageToTxFifoQ(&hfdcan1, &header, data) ;
    HAL_Delay(1000);
}

