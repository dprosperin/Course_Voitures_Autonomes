/*
 * mymain.c
 *
 *  Created on: Jan 6, 2025
 *      Author: yassine.mesbahi
 */
#include "fdcan.h"
#include "stm32g4xx_hal.h"

FDCAN_TxHeaderTypeDef header;
uint8_t data[2];

float vitesse_m_s = 0.0 ;
uint8_t hexa_vitesse ;

float set_anglr()
{
	 float data_lidar_main[360];

	 data_lidar_main [345] = 1522.0; // Assign float value
	 data_lidar_main[45] = 1405.0;  // Assign another float value

	 float difference  = data_lidar_main[345]-data_lidar_main [45] ;
	 float kp = 0.60 ;
	 float angle = 0.0 ;

	 uint16_t hexa ;

	 angle = kp * difference ;

	 hexa = 0x200+(angle/0.35) ;


	 return hexa ;
}

void setup()
{

	/******************* NE PAS TOUCHER **************************************/
	header.ErrorStateIndicator = FDCAN_ESI_ACTIVE;
	header.BitRateSwitch = FDCAN_BRS_OFF;
	header.FDFormat = FDCAN_CLASSIC_CAN;
	header.TxEventFifoControl = FDCAN_NO_TX_EVENTS;
	header.MessageMarker = 0;
	/*************************************************************************/

	header.Identifier = 0x700; // Set your CAN identifier
	header.IdType = FDCAN_STANDARD_ID; // Standard ID
	header.TxFrameType = FDCAN_DATA_FRAME; // Data frame
	header.DataLength = 2; // Data length

}

void loop()
{
	if ( -220 < set_angle() && set_angle() < 220)
	{
		vitesse_m_s = 1.0;
	}
	else
	{
		vitesse_m_s=0.5;
	}

	hexa_vitesse = 0x200*(vitesse_m_s/0.35);
	data [0] = set_angle() ;
	data [1] = hexa_vitesse ;


	HAL_FDCAN_AddMessageToTxFifoQ(&hfdcan1, &header, &data) ;

}

